---
layout:     post
title:     day_05
subtitle:  DHCP部署于安全、DNS部署于安全
date:       2020-4-23
author:     One-Punch-Man
header-img: "img/man-6.jpg"
catalog: true
tags: 
     - 网络安全
     - 千锋教育
---

# DHCP安全与部署

## 概念

- **动态主机设置协议**（英语：**D**ynamic **H**ost **C**onfiguration **P**rotocol，缩写：**DHCP**）是一个用于IP网络的网络协议，位于[OSI模型](https://zh.wikipedia.org/wiki/OSI模型)的[应用层](https://zh.wikipedia.org/wiki/应用层)，使用[UDP](https://zh.wikipedia.org/wiki/用户数据报协议)协议工作。
- 配置**DHCP**就是配置它的**地址池/作用域**，里面包括IP地址、子网掩码、DNS、GW和**租期**。
- DHCP协议的端口是`UDP 67/68`。

## 作用

- 用于内部网或网络服务供应商**自动分配IP地址**给用户。
- 用于内部网管理员对所有电脑作中央管理。

## 优点

- 减少工作量。
- 避免IP冲突。
- 提高IP地址的利用率。

## 原理

DHCP原理也被叫作为DHCP的租约过程：

1. **客户机发送 DHCP discovery广播包**：客户机广播请求IP地址（里面包含客户机的**MAC地址**）。
2. **服务器响应发送 DHCP offer广播包**：服务器响应并提供IP地址。（**不包**含其他信息）
3. **客户机发送 DHCP Request广播包**：客户机选择服务器IP地址并请求包含**租期**的其他信息。
4. **服务器发送 DHCP ACK广播包**：服务器确定了租约并提供网卡的其他详细参数。（IP、子网掩码、DNS、GW、**租期**等）

> 当使用时间超过**50%**以后，客户机会再次发送**DHCP Request**包，进行续约，如服务器**无响应**，则继续使用并在使用时间超过**87.5%**以后再次发送 **DHCP Request**包，进行续约，如果仍然**无响应**，则**释放IP地址**并且重新发送**DHCP Discovery**广播包来获取IP地址。当没有任何一个服务器响应时，客户机会**自动**给自己分配一个`169.254.x.x/16`,属于全球统一无效地址，用于**临时内网通信**。

## 攻击与防御

### DHCP 耗尽攻击

#### 攻击

使用`KaLi Linux`操作系统下的`Yersinia`的攻击工具，频繁的发送伪装DHCP请求，直到把服务器上的DHCP地址池资源耗尽为止。

#### 防御

使用**企业管理型交换机**，并在端口上做动态MAC地址绑定。

### DHCP 假冒攻击

#### 攻击

把自己的主机搭建成DHCP服务器，提供伪冒的非法IP地址。

#### 防御

使用**企业管理型交换机**，并且把除合法的DHCP服务器所在的接口处都设置为禁止发送 DHCP offer 广播包。

### Win2003虚拟机部署DHCP服务器

1. 再虚拟机设置中的DVD/CD插入`Windows2003SP2.iso`镜像文件，设备状态点击已连接；
2. 打开我的电脑，点击`CD驱动器:`，在弹出的页面中选择第三项；双击网络服务，选择DHCP，一路确定；
3. 打开`cmd`，输入 `netstat -an`，出现`67/68`端口，说明安装成功；
4. 点击开始 -> 管理工具 -> DHCP；
5. 右键创建的服务器名 -> 新建作用域 ->输入名字  -> 分配起始IP、结束IP、子网掩码 -> 输入想要排除的IP范围，点击添加 -> 选择租约期限 - > 点击是 -> 输入公司默认的网关，点击添加 -> 输入DNS服务器的IP地址，点击添加 -> 跳过wins服务器的输入 ->不激活，检查完再激活。
6. 点击保留 ->新建保留 -> 填写P地址、客户机MAC地址。（对指定的MAC地址固定分配的IP地址）

- `ipconfig /release`:取消租约并释放IP地址。（手动配置IP也会产生此效果）
- `ipconfig /renew`:如果有IP地址则重新发送Request 广播包续约，没有IP地址则发送Discovery 广播包重新获取IP地址。

# DNS部署于安全

## 域名

**网域名称**（英语：Domain Name，简称：Domain），简称**域名**、**网域**，是由一串用点分隔的字符组成的互联网上某一台计算机或计算机组的名称，用于在数据传输时标识计算机的电子方位。**域名可以说是一个IP地址的代称**，目的是为了便于记忆后者。

`主机名.域名`称为完全限定域名(FQDN)。

### 结构

![yu](\img\day_05_02.png)

### 端口

- `TCP 53`
- `UDP 53`

## DNS解析方式

### 按查询方式

![方式](\img\day_05_01.jpg)

- **递归查询**：  发生在本地主机和本地域名服务器之间以及装有转发器的两台DNS服务器之间。
- **迭代查询**：本地DNS服务器和根等其他DNS服务器之间。

### 按查询内容

- **正向解析**：由域名解析IP地址。
- **反向解析**：由IP地址解析域名。

## DNS服务器搭建

1. 手动设置服务器IP地址
2. 打开我的电脑，点击`CD驱动器:`，在弹出的页面中选择第三项；双击网络服务，选择DNS，一路确定；
3. 打开`cmd`，输入 `netstat -an`，出现`TCP 53`和`UDP 53`端口，说明安装成功；
4. 点击开始 -> 管理工具 -> DNS ->正向查找区域 ->右键选择兴建区域；
5. 除了输入需要解析的**域名**以外其他都点击下一步；
6. 新建主机记录（**A记录**），里面填写需要解析的**主机名**。（正向解析）
7. 先去反向查找区域新建区域，里面填写DNS服务器IP地址前三位，然后去正想查找区域新建主机记录，勾上创建相关指针记录，ip地址为DNS服务器IP地址。（反向解析）

- `nslookup 域名`：客户机上手动解析域名。
- `ipconfig /flushdns`:客户机上清除DNS缓存。
- `ipconfig /displaydns`：客户机上显示DNS缓存。
- 点击查看 -> 高级 -> 清除缓存：服务器上清楚DNS缓存。

### 客户机上的DNS解析

1. 去DNS缓存上找；
2. 本地的`hosts`文件里面找；
3. 发送到本地DNS解析服务器。

### 服务器上的DNS解析

1. DNS高速缓存上找；
2. 本地的区域文件上找；
3. 有转化器则发送出去；
4. 发送到根服务器。

## 两个实验

1. 搭建两台DNS服务器，一个客户端，其中一个DNS服务器中有转化器；能完成域名解析、缓存查看、缓存清除、给DNS服务器设置名字、解析的网站设置别名、设置转发器、设置备份DNS服务器。
2. 使两台虚拟机正常上网，一台为客户机，一台为DNS服务器，重新完成上述的实验。



